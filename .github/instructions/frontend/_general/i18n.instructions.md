---
description: Frontend i18n - i18next setup, RTL support, plurals, namespaces, glossary (reusable across portal-web, storefront-web)
applyTo: "portal-web/**,storefront-web/**"
---

# Frontend Internationalization

i18next-based translation system with Arabic-first, RTL-native approach.

**Cross-refs:**

- Architecture: `./architecture.instructions.md`
- UI patterns: `./ui-patterns.instructions.md` (RTL layout)

---

## 1. Configuration

### Setup

```typescript
// src/i18n/init.ts
import i18next from "i18next";
import { initReactI18next } from "react-i18next";

import arCommon from "./ar/common.json";
import arErrors from "./ar/errors.json";
import enCommon from "./en/common.json";
import enErrors from "./en/errors.json";

i18next.use(initReactI18next).init({
  resources: {
    ar: { common: arCommon, errors: arErrors },
    en: { common: enCommon, errors: enErrors },
  },
  lng: detectLanguage(), // Cookie → browser → 'en'
  fallbackLng: "en",
  defaultNS: "common",
  ns: ["common", "errors"],
  interpolation: {
    escapeValue: false, // React already escapes
  },
});

// Set document attributes
document.documentElement.lang = i18next.language;
document.documentElement.dir = i18next.language === "ar" ? "rtl" : "ltr";

// Update on language change
i18next.on("languageChanged", (lng) => {
  document.documentElement.lang = lng;
  document.documentElement.dir = lng === "ar" ? "rtl" : "ltr";
});
```

### Language Detection

```typescript
// src/i18n/init.ts
function detectLanguage(): "ar" | "en" {
  // 1. Cookie (highest priority)
  const cookie = getCookie("kyora_language");
  if (cookie === "ar" || cookie === "en") return cookie;

  // 2. Browser language
  const browserLang = navigator.language.split("-")[0];
  if (browserLang === "ar") return "ar";

  for (const lang of navigator.languages) {
    if (lang.startsWith("ar")) return "ar";
  }

  // 3. Fallback
  return "en";
}
```

---

## 2. Namespace Organization

### Namespace Responsibilities

- **common**: Shared UI primitives (buttons, states, page titles)
- **errors**: Error messages (HTTP, validation, backend codes)
- **{feature}**: Feature-specific strings (orders, inventory, customers, etc.)

### File Structure

```
src/i18n/
├── ar/
│   ├── common.json
│   ├── errors.json
│   ├── orders.json
│   ├── inventory.json
│   └── customers.json
└── en/
    ├── common.json
    ├── errors.json
    ├── orders.json
    ├── inventory.json
    └── customers.json
```

---

## 3. Usage Patterns

### Explicit Namespace Binding (Required)

```tsx
// ✅ CORRECT - Always bind namespace
const { t } = useTranslation("orders");
t("order_number"); // orders:order_number

const { t: tCommon } = useTranslation("common");
tCommon("save"); // common:save

const { t: tErrors } = useTranslation("errors");
tErrors("http.404"); // errors:http.404
```

### Multiple Namespaces

```tsx
const { t: tCommon } = useTranslation("common");
const { t: tOrders } = useTranslation("orders");

return (
  <>
    <h1>{tOrders("title")}</h1>
    <button>{tCommon("save")}</button>
  </>
);
```

### Forbidden Patterns

```tsx
// ❌ WRONG - Multi-colon pattern
t("orders:order_number");
t("common:actions.save");

// ❌ WRONG - Namespace without binding
useTranslation();
t("save"); // Which namespace?

// ❌ WRONG - Runtime namespace (UI code)
t("save", { ns: "common" }); // Only for shared utilities
```

---

## 4. Translation Key Structure

### Flat Structure (Preferred)

```json
{
  "save": "Save",
  "cancel": "Cancel",
  "loading": "Loading..."
}
```

### Nested Structure (When Keys Group Naturally)

```json
{
  "pages": {
    "dashboard": "Dashboard",
    "inventory": "Inventory",
    "customers": "Customers"
  },
  "validation": {
    "required": "This field is required",
    "invalid_email": "Please enter a valid email"
  }
}
```

### Naming Conventions

- Use `snake_case`: `customer_details`, `add_first_customer`
- Avoid camelCase/PascalCase: ❌ `customerDetails`
- Descriptive names: ✅ `no_customers_message`, ❌ `message1`

---

## 5. Interpolation

### Basic

```json
{
  "welcome_user": "Welcome, {{name}}!"
}
```

```tsx
t("welcome_user", { name: "Ahmed" }); // "Welcome, Ahmed!"
```

### With Objects

```json
{
  "order_total": "Total: {{currency}} {{amount}}"
}
```

```tsx
t("order_total", { currency: "USD", amount: "150.00" });
// "Total: USD 150.00"
```

### Nested Objects

```json
{
  "user_info": "{{user.name}} - {{user.email}}"
}
```

```tsx
t("user_info", { user: { name: "Ahmed", email: "ahmed@example.com" } });
// "Ahmed - ahmed@example.com"
```

---

## 6. Pluralization

### English

```json
{
  "items_count": "{{count}} item",
  "items_count_plural": "{{count}} items"
}
```

```tsx
t("items_count", { count: 1 }); // "1 item"
t("items_count", { count: 5 }); // "5 items"
```

### Arabic (Complex)

Arabic has 6 plural forms:

- zero
- one
- two
- few (3-10)
- many (11-99)
- other (100+)

```json
{
  "items_count_zero": "لا توجد عناصر",
  "items_count_one": "عنصر واحد",
  "items_count_two": "عنصران",
  "items_count_few": "{{count}} عناصر",
  "items_count_many": "{{count}} عنصر",
  "items_count_other": "{{count}} عنصر"
}
```

```tsx
t("items_count", { count: 0 }); // "لا توجد عناصر"
t("items_count", { count: 1 }); // "عنصر واحد"
t("items_count", { count: 2 }); // "عنصران"
t("items_count", { count: 5 }); // "٥ عناصر"
t("items_count", { count: 15 }); // "١٥ عنصر"
t("items_count", { count: 150 }); // "١٥٠ عنصر"
```

---

## 7. RTL Support

### Document Attributes (SSOT)

```typescript
// Read direction
const isRTL = document.documentElement.dir === "rtl";
const currentLang = document.documentElement.lang;

// Or use hook (PREFERRED)
import { useLanguage } from "@/hooks/useLanguage";

const { isRTL, language, isArabic } = useLanguage();
```

### useLanguage Hook

```typescript
// src/hooks/useLanguage.ts
export function useLanguage() {
  const { i18n } = useTranslation();

  return {
    language: i18n.language as "ar" | "en",
    currentLanguage: i18n.language as "ar" | "en",
    isRTL: i18n.language === "ar",
    isArabic: i18n.language === "ar",
    isEnglish: i18n.language === "en",
    changeLanguage: (lng: "ar" | "en") => {
      i18n.changeLanguage(lng);
      setCookie("kyora_language", lng, 365);
    },
    toggleLanguage: () => {
      const newLang = i18n.language === "ar" ? "en" : "ar";
      i18n.changeLanguage(newLang);
      setCookie("kyora_language", newLang, 365);
    },
    supportedLanguages: ["ar", "en"] as const,
  };
}
```

### Usage

```tsx
const { isRTL, changeLanguage } = useLanguage();

// Apply RTL-specific styling
<button className={isRTL ? 'text-end' : 'text-start'}>

// Change language
<button onClick={() => changeLanguage('ar')}>العربية</button>
```

---

## 8. Error Translation

### Backend Error Codes

Backend returns:

```json
{
  "status": 401,
  "detail": "Invalid credentials",
  "extensions": {
    "code": "account.invalid_credentials"
  }
}
```

**Translation mapping:**

```json
// errors.json
{
  "backend": {
    "account.invalid_credentials": "Invalid email or password",
    "account.user_already_exists": "Account already exists"
  },
  "http": {
    "400": "Invalid request",
    "401": "Unauthorized",
    "404": "Not found"
  },
  "generic": {
    "unexpected": "An unexpected error occurred"
  }
}
```

**Portal parsing:**

```typescript
import { translateErrorAsync } from "@/lib/translateError";

try {
  await api.login(credentials);
} catch (error) {
  const translated = await translateErrorAsync(error, t);
  toast.error(translated);
}
```

---

## 9. Adding New Translations

### Add Key to Both Locales

```json
// en/orders.json
{
  "order_created": "Order created successfully"
}

// ar/orders.json
{
  "order_created": "تم إنشاء الطلب بنجاح"
}
```

### Add New Namespace

1. Create files:
   - `src/i18n/ar/{namespace}.json`
   - `src/i18n/en/{namespace}.json`

2. Import in init:

   ```typescript
   import arNamespace from "./ar/namespace.json";
   import enNamespace from "./en/namespace.json";
   ```

3. Register:
   ```typescript
   resources: {
     ar: { /* ... */, namespace: arNamespace },
     en: { /* ... */, namespace: enNamespace },
   },
   ns: ['common', 'errors', /* ... */, 'namespace'],
   ```

---

## 10. Translation Guidelines

### Arabic Best Practices

- Use Modern Standard Arabic (MSA), not dialectal
- Avoid literal translations; adapt to cultural context
- Keep phrasing natural and concise
- Use gendered forms appropriately
- Test RTL layout with real Arabic text

### English Best Practices

- Use American English spelling
- Keep messages short and action-oriented
- Avoid jargon and accounting terms
- Use active voice
- Be consistent with terminology

---

## 11. Common Keys Reference

### Actions (common:\*)

```json
{
  "save": "Save",
  "cancel": "Cancel",
  "delete": "Delete",
  "edit": "Edit",
  "create": "Create",
  "update": "Update",
  "submit": "Submit",
  "confirm": "Confirm",
  "back": "Back",
  "next": "Next",
  "add": "Add",
  "remove": "Remove"
}
```

### States (common:\*)

```json
{
  "loading": "Loading...",
  "no_results": "No results found",
  "empty_state": "Nothing here yet",
  "error_loading": "Failed to load"
}
```

### Validation (errors:validation.\*)

```json
{
  "required": "This field is required",
  "invalid_email": "Please enter a valid email",
  "invalid_phone": "Please enter a valid phone number",
  "min_length": "Must be at least {{min}} characters",
  "max_length": "Must be at most {{max}} characters",
  "positive_number": "Must be a positive number"
}
```

---

## 12. Testing Translations

### Missing Keys

```bash
# Check for missing keys
npm run i18n:check

# Find untranslated strings
grep -r "hardcoded string" src/
```

### RTL Testing

1. Switch to Arabic: `changeLanguage('ar')`
2. Check layout doesn't break
3. Verify text doesn't overflow
4. Test with long Arabic text

---

## Agent Validation

Before completing i18n task:

- ☑ **ZERO** hardcoded user-facing strings
- ☑ All keys use explicit namespace binding
- ☑ Keys exist in **both** ar/ and en/ files
- ☑ Key naming uses `snake_case`
- ☑ Interpolation parameters documented
- ☑ Pluralization forms complete (6 for Arabic)
- ☑ No `t('ns:key')` pattern (forbidden)
- ☑ useLanguage hook used for language/direction checks
- ☑ RTL layout tested with real Arabic text

---

## Resources

- i18next Docs: https://www.i18next.com
- React i18next: https://react.i18next.com
- Arabic Pluralization: https://unicode-org.github.io/cldr-staging/charts/latest/supplemental/language_plural_rules.html#ar
